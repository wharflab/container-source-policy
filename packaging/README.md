# Packaging

This directory contains wrappers for distributing the `container-source-policy` Go binary through package managers.

The wrapper packages are **thin launchers**: they select the correct platform binary and exec it. The bundled binaries are generated by GoReleaser and
copied into place by `packaging/pack.rb`.

## Layout

- `packaging/npm/`
  - `container-source-policy/`: main npm package (JS launcher + optionalDependencies)
  - `container-source-policy-<os>-<arch>/`: platform packages that contain the actual binary under `bin/`
- `packaging/pypi/`
  - `container_source_policy/`: Python launcher package
  - `hatch_build.py`: Hatch build hook that prunes binaries for platform wheels
- `packaging/rubygems/`
  - `bin/container-source-policy`: Ruby launcher
  - `libexec/`: platform binaries (populated during packaging; git-ignored)
- `packaging/pack.rb`: release helper (copies binaries + bumps versions + publishes)

## Release workflow (maintainers)

1. Build release artifacts with GoReleaser (writes to `dist/`):

   ```bash
   goreleaser release --clean --config .goreleaser.yml
   ```

2. Update the package version in `packaging/pack.rb` (`VERSION = "â€¦"`) to match the release tag.

3. Prepare package directories (copies root `README.md` into npm packages and copies binaries from `dist/` into all wrappers):

   ```bash
   ruby packaging/pack.rb prepare
   ```

   Notes:
   - `prepare` runs `git clean -fdX` inside `packaging/` subdirectories to remove ignored build outputs.
   - The copied binaries and per-package README files are git-ignored (see `.gitignore`).

4. Publish (this performs real uploads):

   ```bash
   ruby packaging/pack.rb publish
   ```

   This calls:
   - PyPI: `uv build --wheel` for each platform and `uv publish`
   - npm: `npm publish --access public` for `container-source-policy` and all platform packages
   - RubyGems: `rake build` and `gem push`

## Supported platforms

The wrapper packages expect these GoReleaser-style binary names in `dist/`:

- `container-source-policy_<version>_Linux_x86_64`
- `container-source-policy_<version>_Linux_arm64`
- `container-source-policy_<version>_MacOS_x86_64`
- `container-source-policy_<version>_MacOS_arm64`
- `container-source-policy_<version>_Windows_x86_64.exe`
- `container-source-policy_<version>_Windows_arm64.exe`
- `container-source-policy_<version>_Freebsd_x86_64`
